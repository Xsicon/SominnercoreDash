@page "/confirm-email"
@layout AuthLayout
@rendermode InteractiveServer
@using SominnercoreDash.Services
@inject NavigationManager Navigation
@inject ILogger<ConfirmEmail> Logger
@inject IJSRuntime JS

<PageTitle>Confirm Email - SominnercoreDash</PageTitle>

<div class="rp-container">
    <!-- Gradient Background Effects -->
    <div class="rp-gradient-bg">
        <div class="rp-gradient-orb rp-gradient-orb-1"></div>
        <div class="rp-gradient-orb rp-gradient-orb-2"></div>
    </div>

    <!-- Main Card -->
    <div class="rp-card">
        <!-- Header -->
        <div class="rp-header">
            <div class="rp-brand-section">
                <div class="rp-brand-icon">
                    <span class="material-symbols-outlined">
                        @if (showInitialState)
                        {
                            @:mark_email_unread
                        }
                        else if (isConfirming)
                        {
                            @:hourglass_empty
                        }
                        else if (confirmationSuccess)
                        {
                            @:mark_email_read
                        }
                        else
                        {
                            @:error
                        }
                    </span>
                </div>
                <span class="rp-brand-name">Sominnercore</span>
            </div>

            @if (showInitialState)
            {
                <h1 class="rp-title">Check your email</h1>
                <p class="rp-subtitle">
                    We've sent a verification link to your email address. Please check your inbox and click the link to verify your account.
                </p>
            }
            else if (isConfirming)
            {
                <h1 class="rp-title">Confirming your email...</h1>
                <p class="rp-subtitle">
                    Please wait while we verify your email address.
                </p>
            }
            else if (confirmationSuccess)
            {
                <h1 class="rp-title">Email confirmed!</h1>
                <p class="rp-subtitle">
                    Your email has been successfully verified. You can now sign in to your account.
                </p>
            }
            else
            {
                <h1 class="rp-title">Confirmation failed</h1>
                <p class="rp-subtitle">
                    We couldn't verify your email address. The link may have expired or is invalid.
                </p>
            }
        </div>

        <div class="rp-form" style="text-align: center; padding: 2rem;">
            @if (showInitialState)
            {
                <!-- Initial State - Check Your Email -->
                <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
                    <div style="width: 5rem; height: 5rem; border-radius: 50%; background-color: rgba(19, 127, 236, 0.1); display: flex; align-items: center; justify-content: center;">
                        <span class="material-symbols-outlined" style="font-size: 3rem; color: #137fec; font-variation-settings: 'FILL' 1;">mail</span>
                    </div>
                </div>
                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--rp-text-light);">Verification email sent!</h3>
                <p style="color: var(--rp-text-muted-light); margin-bottom: 1.5rem; font-size: 0.875rem; line-height: 1.6;">
                    We've sent a verification link to your email address. Please check your inbox (and spam folder) and click the link to activate your account.
                </p>
                
                <div style="padding: 1rem; background-color: rgba(19, 127, 236, 0.05); border-radius: 0.5rem; border: 1px solid rgba(19, 127, 236, 0.1); margin-bottom: 1.5rem;">
                    <p style="font-size: 0.8125rem; color: var(--rp-text-muted-light); line-height: 1.5;">
                        <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle; margin-right: 0.25rem;">info</span>
                        Didn't receive the email? Check your spam folder or contact support if you need assistance.
                    </p>
                </div>

                <a href="/signin" class="rp-btn-secondary" style="text-decoration: none;">
                    <span class="material-symbols-outlined">arrow_back</span>
                    <span>Back to Sign In</span>
                </a>
            }
            else if (isConfirming)
            {
                <!-- Loading State -->
                <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
                    <div class="rp-loading-spinner" style="width: 3rem; height: 3rem; border-width: 3px;"></div>
                </div>
                <p style="color: var(--rp-text-muted-light); font-size: 0.875rem;">
                    Verifying your email address...
                </p>
            }
            else if (confirmationSuccess)
            {
                <!-- Success State -->
                <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
                    <div style="width: 5rem; height: 5rem; border-radius: 50%; background-color: rgba(16, 185, 129, 0.1); display: flex; align-items: center; justify-content: center;">
                        <span class="material-symbols-outlined" style="font-size: 3rem; color: #10b981; font-variation-settings: 'FILL' 1;">check_circle</span>
                    </div>
                </div>
                <p style="color: var(--rp-text-muted-light); margin-bottom: 1.5rem; font-size: 0.875rem;">
                    Redirecting you to sign in page in <strong>@countdown</strong> seconds...
                </p>
                <a href="/signin" class="rp-btn-primary" style="text-decoration: none; display: inline-flex;">
                    Sign In Now
                    <span class="material-symbols-outlined">arrow_forward</span>
                </a>
            }
            else
            {
                <!-- Error State -->
                <div style="display: flex; justify-content: center; margin-bottom: 1.5rem;">
                    <div style="width: 5rem; height: 5rem; border-radius: 50%; background-color: rgba(239, 68, 68, 0.1); display: flex; align-items: center; justify-content: center;">
                        <span class="material-symbols-outlined" style="font-size: 3rem; color: #ef4444;">error</span>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="rp-alert rp-alert-error" style="text-align: left; margin-bottom: 1.5rem;">
                        <span class="material-symbols-outlined">info</span>
                        <span>@errorMessage</span>
                    </div>
                }

                <p style="color: var(--rp-text-muted-light); margin-bottom: 1.5rem; font-size: 0.875rem;">
                    Please try signing up again or request a new verification email.
                </p>
                
                <div style="display: flex; gap: 0.75rem; justify-content: center; flex-wrap: wrap;">
                    <a href="/signup" class="rp-btn-primary" style="text-decoration: none; display: inline-flex; width: auto;">
                        Sign Up Again
                    </a>
                    <a href="/signin" class="rp-btn-secondary">
                        Go to Sign In
                    </a>
                </div>
            }
        </div>

        <!-- Back to Login (only show if not confirming and not initial state) -->
        @if (!isConfirming && !showInitialState)
        {
            <div class="rp-footer">
                <a href="/signin" class="rp-back-link">
                    <span class="material-symbols-outlined">arrow_back</span>
                    <span>Back to Login</span>
                </a>
            </div>
        }
    </div>

    <!-- Bottom Links -->
    <div class="rp-bottom-links">
        <a href="/privacy" class="rp-bottom-link">Privacy Policy</a>
        <a href="/help" class="rp-bottom-link">Help Center</a>
    </div>
</div>

@code {
    private bool showInitialState = false;
    private bool isConfirming = false;
    private bool confirmationSuccess = false;
    private string? errorMessage;
    private int countdown = 5;
    private System.Threading.Timer? countdownTimer;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CheckConfirmationState();
        }
    }

    private async Task CheckConfirmationState()
    {
        try
        {
            // Get the URL to check if there's a token
            var url = await JS.InvokeAsync<string>("eval", "window.location.href");
            Logger.LogInformation("Current URL: {Url}", url);

            // Check if URL contains confirmation token
            if (url.Contains("#access_token=") || url.Contains("?token="))
            {
                // User came from email link - process confirmation
                Logger.LogInformation("Token found in URL, processing email confirmation");
                await ProcessEmailConfirmation(url);
            }
            else
            {
                // User just signed up - show initial "check your email" state
                Logger.LogInformation("No token found, showing initial check email state");
                showInitialState = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error checking confirmation state");
            errorMessage = "An error occurred. Please try again.";
            StateHasChanged();
        }
    }

    private async Task ProcessEmailConfirmation(string url)
    {
        try
        {
            isConfirming = true;
            StateHasChanged();

            Logger.LogInformation("Starting email confirmation process");

            // Extract token from URL
            string? token = null;
            
            // Check hash fragment first (Supabase default)
            if (url.Contains("#access_token="))
            {
                var hashIndex = url.IndexOf('#');
                if (hashIndex >= 0)
                {
                    var fragment = url.Substring(hashIndex + 1);
                    var parameters = fragment.Split('&');
                    
                    foreach (var param in parameters)
                    {
                        var keyValue = param.Split('=');
                        if (keyValue.Length == 2 && keyValue[0] == "access_token")
                        {
                            token = keyValue[1];
                            break;
                        }
                    }
                }
            }

            if (string.IsNullOrEmpty(token))
            {
                Logger.LogWarning("Could not extract token from URL");
                errorMessage = "Invalid confirmation link format.";
                isConfirming = false;
                StateHasChanged();
                return;
            }

            Logger.LogInformation("Token extracted successfully");

            // Simulate confirmation (Supabase handles this automatically via the link)
            // The email is confirmed when the user clicks the link
            await Task.Delay(1500); // Brief delay for UX

            // If we got this far, confirmation was successful
            Logger.LogInformation("âœ… Email confirmed successfully");
            confirmationSuccess = true;
            isConfirming = false;
            StateHasChanged();

            // Start countdown timer
            StartCountdown();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during email confirmation");
            errorMessage = "An error occurred while confirming your email. Please try again.";
            isConfirming = false;
            StateHasChanged();
        }
    }

    private void StartCountdown()
    {
        countdownTimer = new System.Threading.Timer(async _ =>
        {
            countdown--;
            
            if (countdown <= 0)
            {
                countdownTimer?.Dispose();
                await InvokeAsync(() =>
                {
                    Navigation.NavigateTo("/signin", forceLoad: true);
                });
            }
            else
            {
                await InvokeAsync(StateHasChanged);
            }
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    public void Dispose()
    {
        countdownTimer?.Dispose();
    }
}
