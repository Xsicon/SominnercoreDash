@page "/reset-password"
@layout AuthLayout
@rendermode InteractiveServer
@using SominnercoreDash.Models
@using SominnercoreDash.Services
@inject SupabaseAuthService AuthService
@inject NavigationManager Navigation
@inject ILogger<ResetPassword> Logger
@inject IJSRuntime JS

<PageTitle>Reset Password - SominnercoreDash</PageTitle>

<div class="rp-container">
    <!-- Gradient Background Effects -->
    <div class="rp-gradient-bg">
        <div class="rp-gradient-orb rp-gradient-orb-1"></div>
        <div class="rp-gradient-orb rp-gradient-orb-2"></div>
    </div>

    <!-- Main Card -->
    <div class="rp-card">
        <!-- Header -->
        <div class="rp-header">
            <div class="rp-brand-section">
                <div class="rp-brand-icon">
                    <span class="material-symbols-outlined">lock_reset</span>
                </div>
                <span class="rp-brand-name">Sominnercore</span>
            </div>
            <h1 class="rp-title">Set new password</h1>
            <p class="rp-subtitle">
                Please choose a password unique to this account. Your new password must be different from previous used passwords.
            </p>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="rp-alert rp-alert-error" style="margin: 0 2rem;">
                <span class="material-symbols-outlined">error</span>
                <span>@errorMessage</span>
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="rp-alert rp-alert-success" style="margin: 0 2rem;">
                <span class="material-symbols-outlined">check_circle</span>
                <span>@successMessage</span>
            </div>
        }

        <!-- Form -->
        <form @onsubmit="HandleResetPassword" class="rp-form">
            <!-- New Password -->
            <div class="rp-form-group">
                <label class="rp-form-label">New Password</label>
                <div class="rp-input-wrapper">
                    <span class="material-symbols-outlined rp-input-icon">lock</span>
                    <input @bind="resetPasswordModel.NewPassword" 
                           @oninput="@((e) => { resetPasswordModel.NewPassword = e.Value?.ToString() ?? string.Empty; CalculatePasswordStrength(resetPasswordModel.NewPassword); })"
                           type="@(showNewPassword ? "text" : "password")"
                           class="rp-form-input" 
                           placeholder="Enter new password"
                           autocomplete="new-password"
                           disabled="@isLoading" />
                    <button type="button" 
                            class="rp-input-toggle" 
                            @onclick="ToggleNewPasswordVisibility"
                            disabled="@isLoading">
                        <span class="material-symbols-outlined">
                            @(showNewPassword ? "visibility_off" : "visibility")
                        </span>
                    </button>
                </div>
            </div>

            <!-- Password Strength Indicator -->
            <div class="rp-strength-section">
                <div class="rp-strength-header">
                    <span class="rp-strength-label">STRENGTH</span>
                    <span class="rp-strength-value rp-@GetStrengthColorClass()">@passwordStrength.Label</span>
                </div>
                <div class="rp-strength-bars">
                    @for (int i = 0; i < 4; i++)
                    {
                        <div class="rp-strength-bar @(i < passwordStrength.Score ? "rp-bar-active" : "rp-bar-inactive") rp-@GetStrengthColorClass()"></div>
                    }
                </div>
            </div>

            <!-- Password Requirements -->
            <div class="rp-requirements-box">
                <p class="rp-requirements-title">MUST CONTAIN:</p>
                <div class="rp-requirement-item">
                    <span class="material-symbols-outlined rp-requirement-icon @(passwordStrength.HasMinLength ? "rp-met" : "rp-unmet")" 
                          style="@(passwordStrength.HasMinLength ? "font-variation-settings: 'FILL' 1;" : "")">
                        @(passwordStrength.HasMinLength ? "check_circle" : "radio_button_unchecked")
                    </span>
                    <p class="rp-requirement-text @(passwordStrength.HasMinLength ? "rp-text-met" : "")">At least 8 characters</p>
                </div>
                <div class="rp-requirement-item">
                    <span class="material-symbols-outlined rp-requirement-icon @(passwordStrength.HasNumber ? "rp-met" : "rp-unmet")"
                          style="@(passwordStrength.HasNumber ? "font-variation-settings: 'FILL' 1;" : "")">
                        @(passwordStrength.HasNumber ? "check_circle" : "radio_button_unchecked")
                    </span>
                    <p class="rp-requirement-text @(passwordStrength.HasNumber ? "rp-text-met" : "")">At least one number</p>
                </div>
                <div class="rp-requirement-item">
                    <span class="material-symbols-outlined rp-requirement-icon @(passwordStrength.HasSpecialChar ? "rp-met" : "rp-unmet")"
                          style="@(passwordStrength.HasSpecialChar ? "font-variation-settings: 'FILL' 1;" : "")">
                        @(passwordStrength.HasSpecialChar ? "check_circle" : "radio_button_unchecked")
                    </span>
                    <p class="rp-requirement-text @(passwordStrength.HasSpecialChar ? "rp-text-met" : "")">At least one special symbol</p>
                </div>
            </div>

            <!-- Confirm Password -->
            <div class="rp-form-group">
                <label class="rp-form-label">Confirm Password</label>
                <div class="rp-input-wrapper">
                    <span class="material-symbols-outlined rp-input-icon">lock</span>
                    <input @bind="resetPasswordModel.ConfirmPassword"
                           type="@(showConfirmPassword ? "text" : "password")"
                           class="rp-form-input" 
                           placeholder="Re-enter new password"
                           autocomplete="new-password"
                           disabled="@isLoading" />
                    <button type="button" 
                            class="rp-input-toggle" 
                            @onclick="ToggleConfirmPasswordVisibility"
                            disabled="@isLoading">
                        <span class="material-symbols-outlined">
                            @(showConfirmPassword ? "visibility_off" : "visibility")
                        </span>
                    </button>
                </div>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="rp-btn-primary" disabled="@isLoading">
                @if (isLoading)
                {
                    <span class="rp-loading-spinner"></span>
                    <span>Resetting Password...</span>
                }
                else
                {
                    <span>Reset Password</span>
                    <span class="material-symbols-outlined">arrow_forward</span>
                }
            </button>

            <!-- Back to Sign In Link -->
            <div class="rp-alternate">
                <p class="rp-alternate-text">
                    Remember your password? 
                    <a href="/signin" class="rp-link-primary">Back to Sign In</a>
                </p>
            </div>
        </form>

        <!-- Footer -->
        <div class="rp-footer">
            <a href="/signin" class="rp-back-link">
                <span class="material-symbols-outlined">arrow_back</span>
                <span>Back to Login</span>
            </a>
        </div>
    </div>

    <!-- Bottom Links -->
    <div class="rp-bottom-links">
        <a href="/privacy" class="rp-bottom-link">Privacy Policy</a>
        <a href="/help" class="rp-bottom-link">Help Center</a>
    </div>
</div>

@code {
    private ResetPasswordModel resetPasswordModel = new();
    private PasswordStrength passwordStrength = new();
    private bool isLoading = false;
    private bool showNewPassword = false;
    private bool showConfirmPassword = false;
    private string? errorMessage;
    private string? successMessage;
    private string? accessToken;
    private string? refreshToken;

    protected override async Task OnInitializedAsync()
    {
        await ExtractTokenFromUrl();
    }

    private async Task ExtractTokenFromUrl()
    {
        try
        {
            var url = await JS.InvokeAsync<string>("eval", "window.location.href");
            
            if (string.IsNullOrEmpty(url))
            {
                errorMessage = "Failed to load page properly. Please try again.";
                return;
            }
            
            if (url.Contains("#access_token="))
            {
                var hashIndex = url.IndexOf('#');
                if (hashIndex >= 0)
                {
                    var fragment = url.Substring(hashIndex + 1);
                    var parameters = fragment.Split('&');
                    
                    foreach (var param in parameters)
                    {
                        var parts = param.Split('=', 2);
                        if (parts.Length == 2)
                        {
                            if (parts[0] == "access_token")
                            {
                                accessToken = parts[1];
                            }
                            else if (parts[0] == "refresh_token")
                            {
                                refreshToken = parts[1];
                            }
                        }
                    }
                }
                
                if (string.IsNullOrEmpty(accessToken))
                {
                    errorMessage = "Invalid reset link format. Please request a new password reset link.";
                }
            }
            else
            {
                errorMessage = "Invalid or missing reset token. Please request a new password reset link.";
            }
            
            CalculatePasswordStrength(string.Empty);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error extracting token from URL");
            errorMessage = "An error occurred. Please request a new password reset link.";
            StateHasChanged();
        }
    }

    private void CalculatePasswordStrength(string password)
    {
        if (string.IsNullOrEmpty(password))
        {
            passwordStrength = new PasswordStrength();
            return;
        }

        passwordStrength.HasMinLength = password.Length >= 8;
        passwordStrength.HasNumber = password.Any(char.IsDigit);
        passwordStrength.HasSpecialChar = password.Any(c => !char.IsLetterOrDigit(c));
        passwordStrength.HasUpperCase = password.Any(char.IsUpper);
        passwordStrength.HasLowerCase = password.Any(char.IsLower);

        int score = 0;
        if (passwordStrength.HasMinLength) score++;
        if (passwordStrength.HasNumber) score++;
        if (passwordStrength.HasSpecialChar) score++;
        if (passwordStrength.HasUpperCase && passwordStrength.HasLowerCase) score++;

        passwordStrength.Score = score;
        passwordStrength.Label = score switch
        {
            0 or 1 => "Weak",
            2 => "Fair",
            3 => "Medium",
            4 => "Strong",
            _ => "Weak"
        };
    }

    private string GetStrengthColorClass()
    {
        return passwordStrength.Score switch
        {
            0 or 1 => "weak",
            2 => "fair",
            3 => "medium",
            4 => "strong",
            _ => "weak"
        };
    }

    private async Task HandleResetPassword()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            successMessage = null;
            StateHasChanged();

            if (string.IsNullOrEmpty(accessToken))
            {
                errorMessage = "Invalid or missing reset token. Please request a new password reset link.";
                return;
            }

            if (passwordStrength.Score < 3)
            {
                errorMessage = "Please choose a stronger password. Your password should meet all the requirements shown above.";
                return;
            }

            if (resetPasswordModel.NewPassword != resetPasswordModel.ConfirmPassword)
            {
                errorMessage = "Passwords do not match. Please try again.";
                return;
            }

            var response = await AuthService.ResetPasswordAsync(accessToken, refreshToken ?? string.Empty, resetPasswordModel.NewPassword);

            if (response.Success)
            {
                successMessage = "Password reset successfully! Redirecting to sign in...";
                StateHasChanged();
                
                await Task.Delay(2000);
                Navigation.NavigateTo("/signin", forceLoad: true);
            }
            else
            {
                errorMessage = response.ErrorMessage ?? "Failed to reset password. Please try again.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error during password reset");
            errorMessage = "An unexpected error occurred. Please try again or request a new reset link.";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ToggleNewPasswordVisibility()
    {
        showNewPassword = !showNewPassword;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        showConfirmPassword = !showConfirmPassword;
    }
}
